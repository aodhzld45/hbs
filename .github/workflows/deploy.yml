name: CI/CD - HSBS_PROD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: hsbs_prod-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-fe:
    name: Build Frontend
    runs-on: ubuntu-latest
    environment: HSBS_PROD
    defaults:
      run:
        working-directory: hsb-fe
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: hsb-fe/package-lock.json

      - name: Inject .env.production from GitHub Secrets
        shell: bash
        run: |
          cat > .env.production <<'ENV'
          REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }}
          ENV
          echo "Created .env.production"

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build
        env:
          CI: ""   # CRA 경고를 에러로 취급하지 않음

      - name: Verify FE build exists
        run: test -d build && ls -lah build

      - name: Upload FE artifact
        uses: actions/upload-artifact@v4
        with:
          name: fe-build
          path: hsb-fe/build

  build-bo:
    name: Build Backend
    runs-on: ubuntu-latest
    environment: HSBS_PROD
    defaults:
      run:
        working-directory: hsb-bo
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Create application-prod.yml from secrets
        shell: bash
        run: |
          cat > src/main/resources/application-prod.yml <<'YAML'
          spring:
            datasource:
              url: ${{ secrets.SPRING_DATASOURCE_URL }}
              username: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
              password: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            jpa:
              hibernate:
                ddl-auto: none
              properties:
                hibernate:
                  format_sql: true
                  dialect: org.hibernate.dialect.MySQL8Dialect
                  physical_naming_strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
              show-sql: true
            servlet:
              multipart:
                max-file-size: 50MB
                max-request-size: 50MB
            mail:
              host: ${{ secrets.MAIL_HOST }}
              port: ${{ secrets.MAIL_PORT }}
              username: ${{ secrets.MAIL_USERNAME }}
              password: ${{ secrets.MAIL_PASSWORD }}
              properties:
                mail.smtp.auth: true
                mail.smtp.starttls.enable: true
              default-encoding: UTF-8
            http:
              encoding:
                charset: UTF-8
                enabled: true
                force: true
          jwt:
            secret: ${{ secrets.JWT_SECRET }}
            expiration: 3600000
          file:
            upload-path: ${{ secrets.FILE_UPLOAD_PATH }}
          server:
            servlet:
              session:
                timeout: 30m
          management:
            endpoints:
              web:
                exposure:
                  include: health,info
            endpoint:
              health:
                show-details: always
          cloud:
            aws:
              credentials:
                access-key: ${{ secrets.AWS_ACCESS_KEY_ID }}
                secret-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              region:
                static: ${{ secrets.AWS_REGION }}
          logging:
            charset:
              console: UTF-8
              file: UTF-8
          springdoc:
            api-docs:
              path: /api-docs
            swagger-ui:
              path: /swagger-ui.html
              operations-sorter: alpha
              tags-sorter: alpha
              display-request-duration: true
          app:
            cors:
              enabled: ${{ secrets.APP_CORS_ENABLED }}
              allowed-origins: ${{ secrets.APP_CORS_ALLOWED }}
          YAML

      - name: Verify prod yml exists
        run: test -f src/main/resources/application-prod.yml

      - name: Grant Gradle wrapper execute permission
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload BO artifact
        uses: actions/upload-artifact@v4
        with:
          name: bo-jar
          path: hsb-bo/build/libs/hsb-bo.jar   # ← 고정 파일명 업로드

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: HSBS_PROD
    needs: [ build-fe, build-bo ]
    steps:
      - name: Download FE artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-build
          path: fe-build

      - name: Download BO artifact
        uses: actions/download-artifact@v4
        with:
          name: bo-jar
          path: bo-jar

      # (진단) 러너에 내려받은 파일들 확인
      - name: Check artifacts on runner
        run: |
          ls -al ./fe-build | head || true
          ls -al ./bo-jar || true
          test -f ./bo-jar/hsb-bo.jar && sha256sum ./bo-jar/hsb-bo.jar

      - name: Clean FE build dir on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            mkdir -p /home/hbs/hbs-fe/build
            rm -rf /home/hbs/hbs-fe/build/*

      - name: Copy FE to server (/home/hbs/hbs-fe/build)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "./fe-build/**"        # ./ 명시
          target: "/home/hbs/hbs-fe/build"
          strip_components: 1
          overwrite: true

      # ★ BO 전송: target은 '디렉터리', strip_components는 0 (깨짐 방지)
      - name: Copy BO jar to server directory (/home/hbs/hbs-be/)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "bo-jar/hsb-bo.jar"
          target: "/home/hbs/hbs-be/"    # 디렉터리(슬래시 필수)
          overwrite: true
          strip_components: 0

      # 전송 후 무결성/이름 정리: 고정 링크로 맞추고, 잘못된 폴더/파일 제거
      - name: Link current jar and cleanup
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            cd /home/hbs/hbs-be

            # 과거에 잘못 생긴 '폴더'를 정리
            if [ -d hsb-bo.jar ]; then
              rm -rf hsb-bo.jar
            fi

            # 심볼릭 링크로 고정 이름 제공 (systemd가 항상 이 경로 실행)
            ln -sfn /home/hbs/hbs-be/hsb-bo.jar /home/hbs/hbs-be/hsb-bo.jar  # idempotent
            # 위 한 줄은 idempotent 하지만 의미가 약하니, 아래처럼 실제 파일을 링크로 통일:
            if [ ! -L hsb-bo.jar ]; then
              rm -f hsb-bo.jar
              ln -s hsb-bo.jar hsb-bo.jar  # no-op; 필요 시 실파일명 -> 링크로 교체
            fi

            # 실제 파일이 링크가 아니라면(=그냥 파일)도 OK이므로 상태만 표시
            ls -l /home/hbs/hbs-be/hsb-bo.jar
            file /home/hbs/hbs-be/hsb-bo.jar || true
            sha256sum /home/hbs/hbs-be/hsb-bo.jar || true

      # --- BO 서비스: 중지 → 시작 + 상태 확인 ---
      - name: Restart backend service (stop -> start)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            echo '${{ secrets.SUDO_PASS }}' | sudo -S systemctl daemon-reload
            echo '${{ secrets.SUDO_PASS }}' | sudo -S systemctl stop hsb-bo || true
            sleep 2
            echo '${{ secrets.SUDO_PASS }}' | sudo -S systemctl start hsb-bo
            echo '${{ secrets.SUDO_PASS }}' | sudo -S systemctl status hsb-bo --no-pager -l || true
            ps -ef | grep '[j]ava' || true



